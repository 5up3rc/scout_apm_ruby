<script language="JavaScript">
(function() {
  /* instrument XMLHttpRequest */
  var open = window.XMLHttpRequest.prototype.open;
  var send = window.XMLHttpRequest.prototype.send;
  function openReplacement(method, url, async, user, password) {
    this._url = url;
    return open.apply(this, arguments);
  }
  function sendReplacement(data) {
    if (this.onload) {
      this._onload = this.onload;
    }
    this.onload = onLoadReplacement;
    return send.apply(this, arguments);
  }
  function onLoadReplacement() {
    // only extract the header if it's a local request (no host specified), or the host IS specified, and it's the same as the window's host
    if(this._url.startsWith(window.location.protocol+"//"+window.location.host) || !this._url.startsWith("http")){
      try {
        traceText = this.getResponseHeader("X-scoutapminstant");
        if(traceText){
          //console.info("Got an AJAX instrumentation with "+traceText.length.toString()+" characters.")
          setTimeout(function(){ window.scoutInstant("addTrace",traceText) },0);
        }
      } catch(e){
        console.debug("Problem getting X-scoutapminstant header");
        console.debug(e);
      }
    }

    if (this._onload) {
      return this._onload.apply(this, arguments);
    }
  }
  window.XMLHttpRequest.prototype.open = openReplacement;
  window.XMLHttpRequest.prototype.send = sendReplacement;
})();
</script>